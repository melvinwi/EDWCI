# design artefact				
# ARTEFACT: TRANSFORM_FactTransaction_Invoice_Charges				
# DESCRIPTION: Promote charge transactions from Orion tables to DataStore 				
SOURCE_FUNCTION_PREFIX	SOURCE	SOURCE_FUNCTION_SUFFIX	DESTINATION	DESCRIPTION
WITH_STATEMENTS	"WITH pricePlan AS (SELECT utl_account_price_plan.seq_product_item_id, utl_price_plan.price_plan_code, utl_price_plan.green_percent, CASE WHEN utl_account_price_plan.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_price_plan.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_price_category.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END AS Meta_HasChanged FROM /* Staging */ [schema].utl_account_price_plan INNER JOIN /* Staging */ [schema].utl_price_plan ON utl_price_plan.price_plan_id = utl_account_price_plan.price_plan_id LEFT JOIN /* Staging */ [schema].utl_price_category ON utl_price_category.price_category_id = utl_price_plan.price_category_id WHERE (utl_account_price_plan.end_date IS NULL OR utl_account_price_plan.end_date > GETDATE()) AND utl_account_price_plan.start_date < GETDATE()), productKey AS (SELECT nc_product_item.seq_product_item_id, (CASE WHEN nc_product_item.tco_id <> 1 THEN CAST(nc_product_item.tco_id AS nvarchar(100)) WHEN utl_contract_term.contract_term_desc = 'Lumo Express' OR utl_contract_term.contract_term_desc = 'Lumo Express 2012' THEN 'Lumo Express' WHEN utl_contract_term.contract_term_desc = 'Lumo Velocity' THEN 'Lumo Velocity' WHEN utl_contract_term.contract_term_desc = 'Lumo Virgin Staff' THEN 'Lumo Virgin Staff' WHEN utl_contract_term.contract_term_desc = 'Lumo Movers' THEN 'Lumo Movers' WHEN utl_contract_term.contract_term_desc = 'Lumo Basic' THEN 'Lumo Basic' WHEN _pricePlan.green_percent = '0.1' THEN 'Lumo Life 10' WHEN _pricePlan.green_percent = '1' THEN 'Lumo Life 100' WHEN left(_pricePlan.price_plan_code,3) IN ('OCC', 'STD') THEN 'Lumo Options' ELSE 'Lumo Advantage' END) AS ProductKey, CASE WHEN nc_product_item.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_contract_term.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _pricePlan.Meta_HasChanged = 1 THEN 1 ELSE 0 END AS Meta_HasChanged FROM /* Staging */ [schema].nc_product_item LEFT JOIN /* Staging */ [schema].utl_contract_term ON utl_contract_term.contract_term_id = nc_product_item.contract_term_id LEFT JOIN pricePlan AS _pricePlan ON _pricePlan.seq_product_item_id = nc_product_item.seq_product_item_id)"			Price plan temporary table price plans of each contract and product name temporary table provides the name of the product for each contract
	_DimAccount.AccountId		FactTransaction.AccountId	One to one mapping
COALESCE(	_DimService.ServiceId	", -1)"	FactTransaction.ServiceId	One to one mapping
COALESCE(	_DimProduct.ProductId	", -1)"	FactTransaction.ProductId	One to one mapping
COALESCE(	_DimFinancialAccount.FinancialAccountKey	", -1)"	FactTransaction.FinancialAccountId	One to one mapping
"CONVERT(NCHAR(8), COALESCE("	inv_client_charges.charge_date	", '9999-12-31'), 112)"	FactTransaction.TransactionDateId	One to one mapping with int cast
COALESCE(	_DimVersion.VersionId	", -1)"	FactTransaction.VersionId	One to one mapping
/*	inv_client_charges.seq_client_charge_id	*/ -1	FactTransaction.UnitTypeId	One to one mapping
/*	inv_client_charges.seq_client_charge_id	*/ 0	FactTransaction.Units	Multiply unit quantities
COALESCE(	inv_invoice_detail.net_amount	", inv_client_charges.charge_amount, 0)"	FactTransaction.Value	One to one mapping
/*	inv_client_charges.seq_client_charge_id	*/ 'AUD'	FactTransaction.Currency	Default
COALESCE(	inv_invoice_detail.tax_amount	", ROUND(inv_client_charges.charge_amount / 10,2),0)"	FactTransaction.Tax	Derive the tax amount
CAST(	inv_client_charges.invoice_description	AS nvarchar(100))	FactTransaction.TransactionDesc	One to one mapping
/*	inv_client_charges.seq_client_charge_id	*/ 'CHG' + CAST(inv_client_charges.seq_client_charge_id AS NVARCHAR(11))	FactTransaction.TransactionKey	Derive the 
SELECTION_CRITERIA	FROM /* Staging */ [schema].inv_client_charges INNER JOIN /* Staging */ [schema].inv_charge_item ON inv_charge_item.seq_charge_item_id = inv_client_charges.seq_charge_item_id LEFT JOIN /* Staging */ [schema].nc_product_item ON nc_product_item.seq_product_item_id = inv_client_charges.seq_product_item_id LEFT JOIN productKey as _productKey ON _productKey.seq_product_item_id = inv_client_charges.seq_product_item_id LEFT JOIN DW_Staging.orion.inv_invoice_detail ON inv_invoice_detail.seq_invoice_detail_id = inv_client_charges.seq_invoice_detail_id INNER JOIN /* Dimensional */ [schema].DimAccount AS _DimAccount ON _DimAccount.AccountKey = inv_client_charges.seq_party_id AND _DimAccount.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimService AS _DimService ON _DimService.ServiceKey = nc_product_item.site_id AND _DimService.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimProduct AS _DimProduct ON _DimProduct.ProductKey = _productKey.ProductKey AND _DimProduct.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimFinancialAccount AS _DimFinancialAccount ON _DimFinancialAccount.FinancialAccountKey = inv_charge_item.seq_account_id AND _DimFinancialAccount.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimVersion AS _DimVersion ON _DimVersion.VersionKey = 'Actual'WHERE (inv_charge_item.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR inv_client_charges.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR nc_product_item.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR inv_invoice_detail.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _productKey.Meta_HasChanged = 1)			
