# design artefact				
# ARTEFACT: TRANSFORM_FactActivity				
# DESCRIPTION: Promote activities from Orion tables to DataStore 				
SOURCE_FUNCTION_PREFIX	SOURCE	SOURCE_FUNCTION_SUFFIX	DESTINATION	DESCRIPTION
WITH_STATEMENTS	"WITH crmElementHierarchy AS (SELECT crm_element_hierarchy.element_id, crm_element_hierarchy.element_struct_code, crm_element_hierarchy.parent_id, crm_element_hierarchy.Meta_LatestUpdate_TaskExecutionInstanceId, row_number() OVER (PARTITION BY crm_element_hierarchy.element_id ORDER BY crm_element_hierarchy.start_date1 DESC) AS recency FROM /* Staging */ [schema].crm_element_hierarchy)"			Latest view of crm_element_hierarchy
	_DimCustomer.CustomerId		FactActivity.CustomerId	One to one mapping
COALESCE(	_DimRepresentative.RepresentativeId	", -1)"	FactActivity.RepresentativeId	One to one mapping
COALESCE(	_DimOrganisation.Organisationid	", -1)"	FactActivity.OrganisationId	One to one mapping
	_DimActivityType.ActivityTypeId		FactActivity.ActivityTypeId	One to one mapping
"CONVERT(NCHAR(8),"	crm_activity.activity_date	", 112)"	FactActivity.ActivityDateId	One to one mapping with date cast
CAST(	crm_activity.activity_date	 AS TIME	FactActivity.ActivityTime	One to one mapping with time cast
	crm_activity_type.default_note		FactActivity.ActivityNotes	One to one mapping
	crm_activity.seq_activity_id		FactActivity.ActivityKey	One to one mapping
SELECTION_CRITERIA	"FROM /* Staging */ [schema].crm_activity INNER JOIN /* Staging */ [schema].crm_activity_type ON crm_activity_type.seq_act_type_id = crm_activity.seq_act_type_id LEFT JOIN crmElementHierarchy AS _crmElementHierarchy ON _crmElementHierarchy.element_id = crm_activity.seq_assignee_id AND _crmElementHierarchy.recency = 1 INNER JOIN /* Dimensional */ [schema].DimCustomer AS _DimCustomer ON _DimCustomer.CustomerKey = crm_activity.seq_party_id AND _DimCustomer.Meta_IsCurrent = 1 INNER JOIN /* Dimensional */ [schema].DimActivityType AS _DimActivityType ON _DimActivityType.ActivityTypeCode = crm_activity_type.act_type_code AND _DimActivityType.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimRepresentative AS _DimRepresentative ON _DimRepresentative.RepresentativeKey = CASE WHEN _crmElementHierarchy.element_struct_code IN ('SALES', 'STAFF') THEN _crmElementHierarchy.element_id END AND _DimRepresentative.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimOrganisation AS _DimOrganisation ON _DimOrganisation.OrganisationKey = CASE WHEN _crmElementHierarchy.element_struct_code IN ('CLIENT', 'SALES', 'STAFF') THEN _crmElementHierarchy.parent_id WHEN _crmElementHierarchy.element_struct_code IN ('COMPANY', 'DEPARTMENT', 'GROUP', 'SALESDEPT', 'SALESGRP') THEN _crmElementHierarchy.element_id END AND _DimOrganisation.Meta_IsCurrent = 1 WHERE crm_activity.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR crm_activity_type.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _crmElementHierarchy.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID"			
