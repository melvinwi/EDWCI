
h2. ARTEFACT: TRANSFORM_DimCustomer_Residential

DESCRIPTION: Promote residential customers from Orion tables to DataStore

|*SOURCE_FUNCTION_PREFIX*	|*SOURCE*	|*SOURCE_FUNCTION_SUFFIX*	|*DESTINATION*	|*DESCRIPTION*	|
|WITH_STATEMENTS	|"WITH customerStatus AS (SELECT "nc_client":../staging/nc_client.textile .seq_party_id, MAX (CASE WHEN utl_account_status.accnt_status_class_id > 1 THEN 1 ELSE 0 END) AS CustomerStatus, MAX (CASE WHEN "nc_client":../staging/nc_client.textile .Meta_ChangeFlag = 1 OR nc_product.Meta_ChangeFlag = 1 OR nc_product_item.Meta_ChangeFlag = 1 THEN 1 ELSE 0 END) AS Meta_ChangeFlag FROM [schema]."nc_client":../staging/nc_client.textile  LEFT OUTER JOIN [schema].nc_product ON nc_product.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id LEFT OUTER JOIN [schema].nc_product_item ON nc_product_item.seq_product_id = nc_product.seq_product_id LEFT OUTER JOIN [schema].utl_account_status ON utl_account_status.accnt_status_id = nc_product_item.accnt_status_id GROUP BY "nc_client":../staging/nc_client.textile .seq_party_id)"	|	|	|	|
|CASE WHEN ISNUMERIC ("crm_party":../staging/crm_party.textile .party_code) = 1 THEN CAST(	|"crm_party":../staging/crm_party.textile .party_code	|AS int) END	|"DimCustomer":../datastore/DimCustomer.textile .CustomerCode	|One to one mapping with int cast and isnumeric to prevent execution plan errors	|
|CAST(	|"nc_client":../staging/nc_client.textile .seq_party_id	|AS int)	|"DimCustomer":../datastore/DimCustomer.textile .CustomerKey	|One to one mapping with int cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .title	|AS nchar(3))	|"DimCustomer":../datastore/DimCustomer.textile .Title	|One to one mapping with nchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .first_name	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .Firstname	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .initials	|AS nchar(10))	|"DimCustomer":../datastore/DimCustomer.textile .MiddleInitial	|One to one mapping with nchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .last_name	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .LastName	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .party_name	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .PartyName	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_1	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .PostalAddressLine1	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_2	|AS nvarchar(50))	|"DimCustomer":../datastore/DimCustomer.textile .PostalSuburb	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_post_code	|AS nchar(4))	|"DimCustomer":../datastore/DimCustomer.textile .PostalPostcode	|One to one mapping with nchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_3	|AS nchar(3))	|"DimCustomer":../datastore/DimCustomer.textile .PostalState	|One to one mapping with nchar cast often truncates	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_addr_1	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialAddressLine1	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_addr_2	|AS nvarchar(50))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialSuburb	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_post_code	|AS nchar(4))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialPostcode	|One to one mapping with nchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_addr_3	|AS nchar(3))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialState	|One to one mapping with nchar cast often truncates	|
|CAST(CONCAT(	|""crm_party":../staging/crm_party.textile .std_code,"crm_party":../staging/crm_party.textile .phone_no"	|) AS nvarchar(24))	|"DimCustomer":../datastore/DimCustomer.textile .PrimaryPhone	|Concatenation and nvarchar cast	|
|CAST(CASE	|"crm_party":../staging/crm_party.textile .primary_phone_type_id	|WHEN '1' THEN 'Landline' WHEN '2' THEN 'Mobile' ELSE 'Unknown' END AS nchar(8))	|"DimCustomer":../datastore/DimCustomer.textile .PrimaryPhoneType	|Decode phone type into readable values	|
|CAST(CONCAT(	|""crm_party":../staging/crm_party.textile .secondary_std_code,"crm_party":../staging/crm_party.textile .secondary_phone_no"	|) AS nvarchar(24))	|"DimCustomer":../datastore/DimCustomer.textile .SecondaryPhone	|Concatenation and nvarchar cast	|
|CAST(CASE	|"crm_party":../staging/crm_party.textile .secondary_phone_type_id	|WHEN '1' THEN 'Landline' WHEN '2' THEN 'Mobile' ELSE 'Unknown' END AS nchar(8))	|"DimCustomer":../datastore/DimCustomer.textile .SecondaryPhoneType	|Decode phone type into readable values	|
|CAST(CASE WHEN LEFT(	|"crm_party":../staging/crm_party.textile .std_code	|",1) = '4' THEN CONCAT("crm_party":../staging/crm_party.textile .std_code, "crm_party":../staging/crm_party.textile .phone_no) WHEN LEFT("crm_party":../staging/crm_party.textile .secondary_std_code,1) = '4' THEN CONCAT("crm_party":../staging/crm_party.textile .secondary_std_code, "crm_party":../staging/crm_party.textile .secondary_phone_no) ELSE 'Unknown' END AS nchar(10))"	|"DimCustomer":../datastore/DimCustomer.textile .MobilePhone	|Derives mobile phone number from primary phone or secondary phone else Unknown	|
|CAST(	|"crm_party":../staging/crm_party.textile .email_address	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .Email	|One to one mapping with nvarchar cast	|
|	|"crm_party":../staging/crm_party.textile .date_of_birth	|	|"DimCustomer":../datastore/DimCustomer.textile .DateOfBirth	|One to one mapping	|
|CAST(CASE	|"crm_element_hierarchy":../staging/crm_element_hierarchy.textile .seq_element_type_id	|WHEN '9' THEN 'Residential' WHEN '8' THEN 'Business' ELSE 'Unknown' END AS nchar(11))	|"DimCustomer":../datastore/DimCustomer.textile .CustomerType	|Decode customer type into readable values	|
|CAST(CASE	|_customerStatus.CustomerStatus	|WHEN 1 THEN 'Active' ELSE 'Inactive' END AS nchar(8))	|"DimCustomer":../datastore/DimCustomer.textile .CustomerStatus	|Use WITH table to populate Customer Status	|
|SELECTION_CRITERIA	|"FROM [schema]."crm_party":../staging/crm_party.textile , [schema]."nc_client":../staging/nc_client.textile , [schema]."crm_element_hierarchy":../staging/crm_element_hierarchy.textile , customerStatus AS _customerStatus  WHERE "nc_client":../staging/nc_client.textile .seq_party_id = "crm_party":../staging/crm_party.textile .seq_party_id AND "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .element_id = "crm_party":../staging/crm_party.textile .seq_party_id AND "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .seq_element_type_id = '9' AND _customerStatus.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id AND ("crm_party":../staging/crm_party.textile .Meta_ChangeFlag = 1 OR "nc_client":../staging/nc_client.textile .Meta_ChangeFlag = 1 OR "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .Meta_ChangeFlag = 1 OR _customerStatus.Meta_ChangeFlag = 1) "|

