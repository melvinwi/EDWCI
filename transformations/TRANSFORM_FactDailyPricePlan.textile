
h2. ARTEFACT: TRANSFORM_FactDailyPricePlan

DESCRIPTION: Promote price plan relationships from Orion tables to DataStore

|*SOURCE_FUNCTION_PREFIX*	|*SOURCE*	|*SOURCE_FUNCTION_SUFFIX*	|*DESTINATION*	|*DESCRIPTION*	|
|WITH_STATEMENTS	|"WITH pricePlan AS (SELECT "utl_account_price_plan":../staging/utl_account_price_plan.textile .seq_product_item_id, utl_price_plan.price_plan_id, utl_price_plan.price_plan_code, utl_price_plan.green_percent, CASE WHEN "utl_account_price_plan":../staging/utl_account_price_plan.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_price_plan.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_price_category.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END AS Meta_HasChanged, row_number() OVER (PARTITION BY "utl_account_price_plan":../staging/utl_account_price_plan.textile .seq_product_item_id ORDER BY "utl_account_price_plan":../staging/utl_account_price_plan.textile .start_date DESC) AS recency FROM /* Staging */ [schema]."utl_account_price_plan":../staging/utl_account_price_plan.textile  INNER JOIN /* Staging */ [schema].utl_price_plan ON utl_price_plan.price_plan_id = "utl_account_price_plan":../staging/utl_account_price_plan.textile .price_plan_id LEFT JOIN /* Staging */ [schema].utl_price_category ON utl_price_category.price_category_id = utl_price_plan.price_category_id WHERE ("utl_account_price_plan":../staging/utl_account_price_plan.textile .end_date IS NULL OR "utl_account_price_plan":../staging/utl_account_price_plan.textile .end_date > GETDATE ()) AND "utl_account_price_plan":../staging/utl_account_price_plan.textile .start_date < GETDATE ()) , productKey AS (SELECT "nc_product_item":../staging/nc_product_item.textile .seq_product_item_id, CASE WHEN "nc_product_item":../staging/nc_product_item.textile .tco_id <> 1 THEN CAST ("nc_product_item":../staging/nc_product_item.textile .tco_id AS nvarchar (100)) WHEN utl_contract_term.contract_term_desc = 'Lumo Express'OR utl_contract_term.contract_term_desc = 'Lumo Express 2012' THEN 'Lumo Express'WHEN utl_contract_term.contract_term_desc = 'Lumo Velocity' THEN 'Lumo Velocity'WHEN utl_contract_term.contract_term_desc = 'Lumo Virgin Staff' THEN 'Lumo Virgin Staff'WHEN utl_contract_term.contract_term_desc = 'Lumo Movers' THEN 'Lumo Movers'WHEN utl_contract_term.contract_term_desc = 'Lumo Basic' THEN 'Lumo Basic'WHEN _pricePlan.green_percent = '0.1' THEN 'Lumo Life 10'WHEN _pricePlan.green_percent = '1' THEN 'Lumo Life 100'WHEN LEFT (_pricePlan.price_plan_code, 3) IN ('OCC', 'STD') THEN 'Lumo Options'ELSE 'Lumo Advantage'END AS ProductKey, CASE WHEN "nc_product_item":../staging/nc_product_item.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_contract_term.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _pricePlan.Meta_HasChanged = 1 THEN 1 ELSE 0 END AS Meta_HasChanged FROM /* Staging */ [schema]."nc_product_item":../staging/nc_product_item.textile  LEFT JOIN /* Staging */ [schema].utl_contract_term ON utl_contract_term.contract_term_id = "nc_product_item":../staging/nc_product_item.textile .contract_term_id LEFT JOIN pricePlan AS _pricePlan ON _pricePlan.seq_product_item_id = "nc_product_item":../staging/nc_product_item.textile .seq_product_item_id AND _pricePlan.recency = 1)"	|	|	|Price plan temporary table price plans of each contract and product name temporary table provides the name of the product for each contract	|
|	|_DimAccount.AccountId	|	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .AccountId	|One to one mapping	|
|	|_DimService.ServiceId	|	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .ServiceId	|One to one mapping	|
|COALESCE(	|_DimProduct.ProductId	|",-1)"	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .ProductId	|One to one mapping	|
|COALESCE(	|_DimPricePlan.PricePlanId	|",-1)"	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .PricePlanId	|One to one mapping with ISNULL	|
|"CONVERT (nchar (8) , COALESCE ( "	|"nc_product_item":../staging/nc_product_item.textile .frmp_date	|", '9999-12-31') , 112) "	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .ContractFRMPDateId	|One to one mapping with int cast	|
|"CASE WHEN "utl_account_status":../staging/utl_account_status.textile .accnt_status_class_id = 1 THEN CONVERT(NCHAR(8), COALESCE("	|"nc_product_item":../staging/nc_product_item.textile .date_terminated	|", "nc_product_item":../staging/nc_product_item.textile .accnt_status_date, '9999-12-31') , 112) WHEN  "utl_account_status":../staging/utl_account_status.textile .accnt_status_class_id = 2 THEN 99991231 ELSE CONVERT (nchar (8) , COALESCE ( "nc_product_item":../staging/nc_product_item.textile .date_terminated , '9999-12-31') , 112) END"	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .ContractTerminatedDateId	|One to one mapping with int cast	|
|CAST(CASE	|"utl_account_status":../staging/utl_account_status.textile .accnt_status_class_id	|WHEN 2 THEN 'Open' WHEN 3 THEN 'Pending' WHEN 4 THEN 'Error' ELSE 'Closed' END AS nchar(10))	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .ContractStatus	|One to one mapping with int cast	|
|"CONVERT(NCHAR(8), ISNULL("	|"utl_account_price_plan":../staging/utl_account_price_plan.textile .start_date	|", '9999-12-31'), 112)"	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .DailyPricePlanStartDateId	|One to one mapping with int cast	|
|"CONVERT(NCHAR(8), ISNULL("	|"utl_account_price_plan":../staging/utl_account_price_plan.textile .end_date	|", '9999-12-31'), 112)"	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .DailyPricePlanEndDateId	|One to one mapping with int cast	|
|	|"utl_account_price_plan":../staging/utl_account_price_plan.textile .acnt_price_plan_id	|	|"FactDailyPricePlan":../datastore/FactDailyPricePlan.textile .DailyPricePlanKey	|Decode account status into readable values	|
|SELECTION_CRITERIA	|FROM /* Staging */ [schema]."utl_account_price_plan":../staging/utl_account_price_plan.textile  INNER JOIN /* Staging */ [schema]."nc_product_item":../staging/nc_product_item.textile  ON "nc_product_item":../staging/nc_product_item.textile .seq_product_item_id = "utl_account_price_plan":../staging/utl_account_price_plan.textile .seq_product_item_id INNER JOIN /* Staging */ [schema].nc_product ON nc_product.seq_product_id = "nc_product_item":../staging/nc_product_item.textile .seq_product_id INNER JOIN /* Dimensional */ [schema].DimAccount AS _DimAccount ON _DimAccount.AccountKey = nc_product.seq_party_id AND _DimAccount.Meta_IsCurrent = 1 INNER JOIN /* Dimensional */ [schema].DimService AS _DimService ON _DimService.ServiceKey = CAST ("nc_product_item":../staging/nc_product_item.textile .site_id AS int) AND _DimService.Meta_IsCurrent = 1 INNER JOIN productKey AS _productKey ON _productKey.seq_product_item_id = "nc_product_item":../staging/nc_product_item.textile .seq_product_item_id LEFT JOIN /* Dimensional */ [schema].DimProduct AS _DimProduct ON _DimProduct.ProductKey = _productKey.ProductKey AND _DimProduct.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimPricePlan AS _DimPricePlan ON _DimPricePlan.PricePlanKey = N'DAILY.' + CAST("utl_account_price_plan":../staging/utl_account_price_plan.textile .price_plan_id AS nvarchar(20)) AND _DimPricePlan.Meta_IsCurrent = 1 LEFT JOIN /* Staging */ [schema]."utl_account_status":../staging/utl_account_status.textile  ON "utl_account_status":../staging/utl_account_status.textile .accnt_status_id = "nc_product_item":../staging/nc_product_item.textile .accnt_status_id WHERE "utl_account_price_plan":../staging/utl_account_price_plan.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR nc_product.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR "nc_product_item":../staging/nc_product_item.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _productKey.Meta_HasChanged = 1 OR "utl_account_status":../staging/utl_account_status.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _DimAccount.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _DimService.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _DimProduct.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _DimPricePlan.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID|

