
h2. ARTEFACT: TRANSFORM_DimCustomer_Business

DESCRIPTION: Promote business customers from Orion tables to DataStore

|*SOURCE_FUNCTION_PREFIX*	|*SOURCE*	|*SOURCE_FUNCTION_SUFFIX*	|*DESTINATION*	|*DESCRIPTION*	|
|WITH_STATEMENTS	|"WITH contacts AS (SELECT "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .element_id, "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .parent_id, "crm_party":../staging/crm_party.textile .title, "crm_party":../staging/crm_party.textile .first_name, "crm_party":../staging/crm_party.textile .initials, "crm_party":../staging/crm_party.textile .last_name, "crm_party":../staging/crm_party.textile .date_of_birth, ROW_NUMBER () OVER (PARTITION BY "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .parent_id ORDER BY "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .element_id ASC) AS RC FROM [schema]."crm_element_hierarchy":../staging/crm_element_hierarchy.textile  INNER JOIN [schema]."crm_party":../staging/crm_party.textile  ON "crm_party":../staging/crm_party.textile .seq_party_id = "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .element_id INNER JOIN [schema]."crm_party":../staging/crm_party.textile _flag ON "crm_party":../staging/crm_party.textile _flag.seq_party_id = "crm_party":../staging/crm_party.textile .seq_party_id WHERE "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .active = 'Y' AND "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .element_struct_code = 'CONTACT' AND "crm_party":../staging/crm_party.textile _flag.seq_party_flag_type_id = '1') , customerStatus AS (SELECT "nc_client":../staging/nc_client.textile .seq_party_id, MAX (CASE WHEN utl_account_status.accnt_status_class_id = 2 THEN 1 ELSE 0 END) AS CustomerStatus, MAX (CASE WHEN "nc_client":../staging/nc_client.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR nc_product.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR nc_product_item.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema]."nc_client":../staging/nc_client.textile  LEFT OUTER JOIN [schema].nc_product ON nc_product.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id LEFT OUTER JOIN [schema].nc_product_item ON nc_product_item.seq_product_id = nc_product.seq_product_id LEFT OUTER JOIN [schema].utl_account_status ON utl_account_status.accnt_status_id = nc_product_item.accnt_status_id GROUP BY "nc_client":../staging/nc_client.textile .seq_party_id), ombudsmanComplaints AS (SELECT Complaint.ClientId, Complaint.IsOmbudsman, MAX(CASE WHEN Complaint.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema].Complaint WHERE Complaint.IsOmbudsman = 1 AND Complaint.DateCreated > DATEADD(year, -1, GETDATE()) GROUP BY Complaint.ClientId, Complaint.IsOmbudsman), joinDate AS (SELECT "nc_client":../staging/nc_client.textile .seq_party_id, MIN(ISNULL(nc_product.voice_ver_date,'9999-12-31')) AS EarliestVVDate, MAX (CASE WHEN "nc_client":../staging/nc_client.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR nc_product.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema]."nc_client":../staging/nc_client.textile  LEFT OUTER JOIN [schema].nc_product ON nc_product.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id GROUP BY "nc_client":../staging/nc_client.textile .seq_party_id)"	|	|	|Contacts temporary table selects the first billing contact for each account and status temporary table provides a binary value for active or inactive and ombudsman complaint temporary table provides the party codes with ombudsman complaints	|
|CAST(	|"nc_client":../staging/nc_client.textile .seq_party_id	|AS int)	|"DimCustomer":../datastore/DimCustomer.textile .CustomerKey	|One to one mapping with int cast	|
|CASE WHEN ISNUMERIC ("crm_party":../staging/crm_party.textile .party_code) = 1 THEN CAST (	|"crm_party":../staging/crm_party.textile .party_code	|AS int) END	|"DimCustomer":../datastore/DimCustomer.textile .CustomerCode	|One to one mapping with int cast and isnumeric to prevent execution plan errors	|
|CAST(	|_contacts.title	|AS nchar(3))	|"DimCustomer":../datastore/DimCustomer.textile .Title	|One to one mapping with nchar cast from Contact record	|
|CAST(	|_contacts.first_name	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .Firstname	|One to one mapping with nvarchar cast from Contact record	|
|CAST(	|_contacts.initials	|AS nchar(10))	|"DimCustomer":../datastore/DimCustomer.textile .MiddleInitial	|One to one mapping with nchar cast from Contact record	|
|CAST(	|_contacts.last_name	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .LastName	|One to one mapping with nvarchar cast from Contact record	|
|CAST(	|"crm_party":../staging/crm_party.textile .party_name	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .PartyName	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_1	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .PostalAddressLine1	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_2	|AS nvarchar(50))	|"DimCustomer":../datastore/DimCustomer.textile .PostalSuburb	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_post_code	|AS nchar(4))	|"DimCustomer":../datastore/DimCustomer.textile .PostalPostcode	|One to one mapping with nchar cast	|
|CASE WHEN LEFT(UPPER(	|"crm_party":../staging/crm_party.textile .postal_addr_3	|"),3) IN ('ACT','NSW','NT','QLD','SA','TAS','VIC','WA') THEN LEFT(UPPER("crm_party":../staging/crm_party.textile .postal_addr_3),3) ELSE NULL END"	|"DimCustomer":../datastore/DimCustomer.textile .PostalState	|One to one mapping with nchar cast often truncates	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_3	|AS nchar(3))	|"DimCustomer":../datastore/DimCustomer.textile .PostalStateAsProvided	|One to one mapping with nchar cast often truncates	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_addr_1	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialAddressLine1	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_addr_2	|AS nvarchar(50))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialSuburb	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_post_code	|AS nchar(4))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialPostcode	|One to one mapping with nchar cast	|
|CASE WHEN LEFT(UPPER(	|"crm_party":../staging/crm_party.textile .street_addr_3	|"),3) IN ('ACT','NSW','NT','QLD','SA','TAS','VIC','WA') THEN LEFT(UPPER("crm_party":../staging/crm_party.textile .street_addr_3),3) ELSE NULL END"	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialState	|One to one mapping with nchar cast often truncates	|
|CAST(	|"crm_party":../staging/crm_party.textile .street_addr_3	|AS nchar(3))	|"DimCustomer":../datastore/DimCustomer.textile .ResidentialStateAsProvided	|One to one mapping with nchar cast often truncates	|
|CAST(CONCAT(	|""crm_party":../staging/crm_party.textile .std_code, "crm_party":../staging/crm_party.textile .phone_no"	|) AS nvarchar(24))	|"DimCustomer":../datastore/DimCustomer.textile .PrimaryPhone	|Concatenation and nvarchar cast	|
|CAST(CASE	|"crm_party":../staging/crm_party.textile .primary_phone_type_id	|WHEN '1' THEN 'Landline' WHEN '2' THEN 'Mobile' ELSE NULL END AS nchar(8))	|"DimCustomer":../datastore/DimCustomer.textile .PrimaryPhoneType	|Decode phone type into readable values	|
|CAST(CONCAT(	|"crm_party":../staging/crm_party.textile .secondary_std_code	|", "crm_party":../staging/crm_party.textile .secondary_phone_no) AS nvarchar(24))"	|"DimCustomer":../datastore/DimCustomer.textile .SecondaryPhone	|Concatenation and nvarchar cast	|
|CAST(CASE	|"crm_party":../staging/crm_party.textile .secondary_phone_type_id	|WHEN '1' THEN 'Landline' WHEN '2' THEN 'Mobile' ELSE NULL END AS nchar(8))	|"DimCustomer":../datastore/DimCustomer.textile .SecondaryPhoneType	|Decode phone type into readable values	|
|CAST(CASE WHEN LEFT(	|"crm_party":../staging/crm_party.textile .std_code	|",2) = '04' THEN CONCAT("crm_party":../staging/crm_party.textile .std_code, "crm_party":../staging/crm_party.textile .phone_no) WHEN LEFT("crm_party":../staging/crm_party.textile .secondary_std_code,2) = '04' THEN CONCAT("crm_party":../staging/crm_party.textile .secondary_std_code, "crm_party":../staging/crm_party.textile .secondary_phone_no) ELSE NULL END AS nchar(10))"	|"DimCustomer":../datastore/DimCustomer.textile .MobilePhone	|Derives mobile phone number from primary phone or secondary phone else Unknown	|
|CAST(	|"crm_party":../staging/crm_party.textile .email_address	|AS nvarchar(100))	|"DimCustomer":../datastore/DimCustomer.textile .Email	|One to one mapping with nvarchar cast	|
|	|_contacts.date_of_birth	|	|"DimCustomer":../datastore/DimCustomer.textile .DateOfBirth	|One to one mapping from Contact record	|
|CAST(CASE	|"crm_element_hierarchy":../staging/crm_element_hierarchy.textile .seq_element_type_id	|WHEN '9' THEN 'Residential' WHEN '8' THEN 'Business' ELSE NULL END AS nchar(11))	|"DimCustomer":../datastore/DimCustomer.textile .CustomerType	|Decode customer type into readable values	|
|CAST(CASE	|_customerStatus.CustomerStatus	|WHEN 1 THEN 'Active' ELSE 'Inactive' END AS nchar(8))	|"DimCustomer":../datastore/DimCustomer.textile .CustomerStatus	|Use WITH table to populate Customer Status	|
|CAST(CASE	|_ombudsmanComplaints.IsOmbudsman	|WHEN 1 THEN 'Yes' ELSE 'No' END AS nchar(3))	|"DimCustomer":../datastore/DimCustomer.textile .OmbudsmanComplaints	|Use WITH table to populate Ombudsman Complaints	|
|	|"crm_party":../staging/crm_party.textile .insert_datetime	|	|"DimCustomer":../datastore/DimCustomer.textile .CreationDate	|Insert datetime to populate Creation Date	|
|CASE WHEN	|_joinDate.EarliestVVDate	|= '9999-12-31' THEN "nc_client":../staging/nc_client.textile .insert_datetime ELSE _joinDate.EarliestVVDate END	|"DimCustomer":../datastore/DimCustomer.textile .JoinDate	|Use WITH table to populate Join Date	|
|CASE	|"nc_client":../staging/nc_client.textile .promo_allowed	|WHEN 'E' THEN 'Preferred contact by email' WHEN 'P' THEN 'Preferred contact by phone' WHEN 'Y' THEN 'Preferred contact by mail' WHEN 'N' THEN 'Privacy: Do Not Contact' ELSE NULL END	|"DimCustomer":../datastore/DimCustomer.textile .PrivacyPreferredStatus	|Decode promo allowed to privacy preferred status	|
|SELECTION_CRITERIA	|FROM [schema]."nc_client":../staging/nc_client.textile  INNER JOIN [schema]."crm_party":../staging/crm_party.textile  ON "nc_client":../staging/nc_client.textile .seq_party_id = "crm_party":../staging/crm_party.textile .seq_party_id INNER JOIN [schema]."crm_element_hierarchy":../staging/crm_element_hierarchy.textile  ON "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .element_id = "crm_party":../staging/crm_party.textile .seq_party_id INNER JOIN contacts AS _contacts ON _contacts.parent_id = "nc_client":../staging/nc_client.textile .seq_party_id INNER JOIN customerStatus AS _customerStatus ON _customerStatus.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id LEFT OUTER JOIN ombudsmanComplaints AS _ombudsmanComplaints ON _ombudsmanComplaints.ClientId = "crm_party":../staging/crm_party.textile .party_code LEFT OUTER JOIN joinDate AS _joinDate ON _joinDate.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id WHERE "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .seq_element_type_id = '8'AND _contacts.RC = '1' AND ("crm_party":../staging/crm_party.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR "nc_client":../staging/nc_client.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR "crm_element_hierarchy":../staging/crm_element_hierarchy.textile .Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _customerStatus.Meta_HasChanged = 1 OR _ombudsmanComplaints.Meta_HasChanged = 1 OR _joinDate.Meta_HasChanged = 1)|

