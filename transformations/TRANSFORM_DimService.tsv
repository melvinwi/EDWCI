# design artefact				
# ARTEFACT: TRANSFORM_DimService				
# DESCRIPTION: Promote services from Orion site table to DataStore 				
SOURCE_FUNCTION_PREFIX	SOURCE	SOURCE_FUNCTION_SUFFIX	DESTINATION	DESCRIPTION
WITH_STATEMENTS	"WITH meterDailyConsumption AS (SELECT utl_meter.site_id, SUM(utl_meter.est_daily_consumption) as est_daily_consumption, SUM(CASE WHEN utl_meter.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged FROM /* Staging */ [schema].utl_meter GROUP BY utl_meter.site_id)"			
CAST(	utl_site.site_id	AS int)	DimService.ServiceKey	One to one mapping with int cast
CAST(	utl_site.site_identifier	AS nvarchar(30))	DimService.MarketIdentifier	One to one mapping with nvarchar cast
CAST(CASE	utl_site.seq_product_type_id	WHEN '1' THEN 'Internet' WHEN '2' THEN 'Electricity' WHEN '3' THEN 'Gas' WHEN '7' THEN 'Telco' ELSE NULL END AS nvarchar(11))	DimService.ServiceType	One to one mapping with nvarchar cast
COALESCE(	utl_distrib_loss_factor_sched.dlf_factor	",1.0)"	DimService.LossFactor	One to one mapping
COALESCE(	_meterDailyConsumption.est_daily_consumption	",0.0)"	DimService.EstimatedDailyConsumption	
CAST(CASE	utl_site.metering_type	WHEN 'DEEMED' THEN 'Deemed' ELSE utl_site.metering_type END AS nchar(6))	DimService.MeteringType	
CAST(UPPER(	utl_site.addr_suburb	) AS nvarchar(100))	DimService.ResidentialSuburb	
CAST(	utl_site.addr_postcode	AS nchar(4))	DimService.ResidentialPostcode	
CAST(	utl_site.addr_city	AS nchar(3))	DimService.ResidentialState	
SELECTION_CRITERIA	"FROM [schema].utl_site LEFT JOIN [schema].utl_distrib_loss_factor_sched ON utl_distrib_loss_factor_sched.dlf_id = utl_site.dlf_id LEFT JOIN meterDailyConsumption AS _meterDailyConsumption on _meterDailyConsumption.site_id = utl_site.site_id WHERE utl_distrib_loss_factor_sched.start_date < GETDATE() AND ISNULL(utl_distrib_loss_factor_sched.end_date,'9999-12-31') > GETDATE() AND (utl_site.Meta_LatestUpdate_TaskExecutionInstanceId  > @LatestSuccessfulTaskExecutionInstanceID OR utl_distrib_loss_factor_sched.Meta_LatestUpdate_TaskExecutionInstanceId  > @LatestSuccessfulTaskExecutionInstanceID OR _meterDailyConsumption.Meta_HasChanged = 1)"			
