# design artefact				
# ARTEFACT: TRANSFORM_DimActivityType				
# DESCRIPTION: Promote DimMarketingOffer from spreadsheet sourced tables to DataStore				
SOURCE_FUNCTION_PREFIX	SOURCE	SOURCE_FUNCTION_SUFFIX	DESTINATION	DESCRIPTION
WITH_STATEMENTS	"WITH marketing AS (SELECT crm_activity_type.seq_act_type_id, row_number() OVER (PARTITION BY crm_activity_type.act_type_code ORDER BY crm_activity_type.seq_act_type_id DESC) AS recency FROM /* Staging */ [schema].crm_activity_type INNER JOIN /* Staging */ [schema].csv_DimMarketingOffer ON csv_DimMarketingOffer.MarketingOfferShortDesc = crm_activity_type.act_type_code WHERE crm_activity_type.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR csv_DimMarketingOffer.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID), complaint AS (SELECT crm_activity_type.seq_act_type_id FROM /* Staging */ [schema].crm_activity_type INNER JOIN /* Staging */ [schema].crm_activity_category ON crm_activity_category.seq_act_category_id = crm_activity_type.seq_act_category_id AND crm_activity_category.act_cat_code IN ('COMPLAINT_A', 'COMPLAINT_C', 'COMPL_CN') WHERE crm_activity_type.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR crm_activity_category.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID), enquiry AS (SELECT DISTINCT crm_activity.seq_act_type_id FROM /* Staging */ [schema].crm_activity INNER JOIN /* Staging */ [schema].crm_activity_source ON crm_activity_source.seq_act_source_id = crm_activity.seq_act_source_id AND crm_activity_source.act_source_code IN ('EMAIL IN', 'FAX IN', 'LETTER IN', 'LIVECHAT', 'PHONE IN') WHERE crm_activity.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR crm_activity_source.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID), retention AS (SELECT crm_activity_type.seq_act_type_id FROM /* Staging */ [schema].crm_activity_type WHERE crm_activity_type.seq_act_type_id IN (1010, 1057, 2122, 1286, 1647, 1648, 1904, 2127, 1913, 2647, 2648, 1043, 1287, 1758, 1759, 1760, 1761, 1762, 1763, 1902, 2128, 2123, 1903, 2130, 2156, 2158, 2512) AND crm_activity_type.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID)"			Identify marketing, complaint and enquiry activity types
CAST(	crm_activity_type.seq_act_type_id	AS int)	DimActivityType.ActivityTypeKey	One to one mapping
CAST(	crm_activity_type.act_type_code	AS nvarchar(20))	DimActivityType.ActivityTypeCode	One to one mapping
CAST(	crm_activity_type.act_type_desc	AS nvarchar(100))	DimActivityType.ActivityTypeDesc	One to one mapping
SELECTION_CRITERIA	"FROM /* Staging */ [schema].crm_activity_type LEFT JOIN marketing ON marketing.seq_act_type_id = crm_activity_type.seq_act_type_id AND marketing.recency = 1 LEFT JOIN complaint ON complaint.seq_act_type_id = crm_activity_type.seq_act_type_id LEFT JOIN enquiry ON enquiry.seq_act_type_id = crm_activity_type.seq_act_type_id LEFT JOIN retention ON retention.seq_act_type_id = crm_activity_type.seq_act_type_id WHERE (marketing.seq_act_type_id IS NOT NULL OR complaint.seq_act_type_id IS NOT NULL OR enquiry.seq_act_type_id IS NOT NULL OR retention.seq_act_type_id IS NOT NULL)"			
