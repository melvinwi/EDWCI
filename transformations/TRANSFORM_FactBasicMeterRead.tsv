# design artefact				
# ARTEFACT: TRANSFORM_FactBasicMeterRead				
# DESCRIPTION: Promote basic meter reads from Orion tables to DataStore 				
SOURCE_FUNCTION_PREFIX	SOURCE	SOURCE_FUNCTION_SUFFIX	DESTINATION	DESCRIPTION
WITH_STATEMENTS	"WITH pricePlan AS (SELECT utl_account_price_plan.seq_product_item_id, utl_price_plan.price_plan_id, utl_price_plan.price_plan_code, utl_price_plan.green_percent, CASE WHEN utl_account_price_plan.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_price_plan.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_price_category.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END AS Meta_HasChanged, row_number() OVER (PARTITION BY utl_account_price_plan.seq_product_item_id ORDER BY utl_account_price_plan.start_date DESC) AS recency FROM /* Staging */ [schema].utl_account_price_plan INNER JOIN /* Staging */ [schema].utl_price_plan ON utl_price_plan.price_plan_id = utl_account_price_plan.price_plan_id LEFT JOIN /* Staging */ [schema].utl_price_category ON utl_price_category.price_category_id = utl_price_plan.price_category_id WHERE (utl_account_price_plan.end_date IS NULL OR utl_account_price_plan.end_date > GETDATE ()) AND utl_account_price_plan.start_date < GETDATE ()) , productKey AS (SELECT nc_product_item.seq_product_item_id, CASE WHEN nc_product_item.tco_id <> 1 THEN CAST (nc_product_item.tco_id AS nvarchar (100)) WHEN utl_contract_term.contract_term_desc = 'Lumo Express'OR utl_contract_term.contract_term_desc = 'Lumo Express 2012' THEN 'Lumo Express'WHEN utl_contract_term.contract_term_desc = 'Lumo Velocity' THEN 'Lumo Velocity'WHEN utl_contract_term.contract_term_desc = 'Lumo Virgin Staff' THEN 'Lumo Virgin Staff'WHEN utl_contract_term.contract_term_desc = 'Lumo Movers' THEN 'Lumo Movers'WHEN utl_contract_term.contract_term_desc = 'Lumo Basic' THEN 'Lumo Basic'WHEN _pricePlan.green_percent = '0.1' THEN 'Lumo Life 10'WHEN _pricePlan.green_percent = '1' THEN 'Lumo Life 100'WHEN LEFT (_pricePlan.price_plan_code, 3) IN ('OCC', 'STD') THEN 'Lumo Options'ELSE 'Lumo Advantage'END AS ProductKey, CASE WHEN nc_product_item.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_contract_term.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _pricePlan.Meta_HasChanged = 1 THEN 1 ELSE 0 END AS Meta_HasChanged FROM /* Staging */ [schema].nc_product_item LEFT JOIN /* Staging */ [schema].utl_contract_term ON utl_contract_term.contract_term_id = nc_product_item.contract_term_id LEFT JOIN pricePlan AS _pricePlan ON _pricePlan.seq_product_item_id = nc_product_item.seq_product_item_id AND _pricePlan.recency = 1)"			Price plan temporary table price plans of each contract and product name temporary table provides the name of the product for each contract
COALESCE(	_DimAccount.AccountId	",-1)"	FactBasicMeterRead.AccountId	One to one mapping
COALESCE(	_DimService.ServiceId	",-1)"	FactBasicMeterRead.ServiceId	One to one mapping
COALESCE(	_DimProduct.ProductId	",-1)"	FactBasicMeterRead.ProductId	One to one mapping
COALESCE(	_DimMeterRegister.MeterRegisterId	",-1)"	FactBasicMeterRead.MeterRegisterId	One to one mapping with ISNULL
	utl_meter_read.meter_read_id		FactBasicMeterRead.BasicMeterReadKey	One to one mapping with int cast
CAST(	utl_read_type.read_type_desc	AS nvarchar(100))	FactBasicMeterRead.ReadType	One to one mapping with int cast
CAST(	utl_read_sub_type.read_sub_type_desc	AS nvarchar(100))	FactBasicMeterRead.ReadSubtype	One to one mapping with int cast
COALESCE(	utl_meter_read.meter_read	", 0.0)"	FactBasicMeterRead.ReadValue	One to one mapping with int cast
"CONVERT (nchar (8) , COALESCE ( "	utl_meter_read.read_date	", '9999-12-31') , 112)"	FactBasicMeterRead.ReadDateId	One to one mapping with int cast
CAST(CASE	utl_meter_read.estimated_read	WHEN 'Y' THEN N'Yes' ELSE N'No ' END AS nchar(3))	FactBasicMeterRead.EstimatedRead	Decode account status into readable values
COALESCE(	utl_meter_read.period_id	",-1)"	FactBasicMeterRead.ReadPeriod	One to one mapping with int cast
CAST(	utl_meter_read.quality_method	AS nvarchar(20))	FactBasicMeterRead.QualityMethod	Default with int cast
COALESCE(	utl_meter_read.add_factor	",0)"	FactBasicMeterRead.AddFactor	
SELECTION_CRITERIA	FROM /* Staging */ [schema].utl_meter_read INNER JOIN /* Staging */ [schema].utl_read_type ON utl_read_type.read_type_id = utl_meter_read.read_type_id INNER JOIN /* Staging */ [schema].utl_read_sub_type ON utl_read_sub_type.read_sub_type_id = utl_meter_read.read_sub_type_id INNER JOIN /* Staging */ [schema].nc_product_item ON nc_product_item.seq_product_item_id = utl_meter_read.seq_product_item_id INNER JOIN /* Staging */ [schema].nc_product ON nc_product.seq_product_id = nc_product_item.seq_product_id LEFT JOIN /* Dimensional */ [schema].DimAccount AS _DimAccount ON _DimAccount.AccountKey = nc_product.seq_party_id AND _DimAccount.Meta_IsCurrent = 1 LEFT JOIN /* Dimensional */ [schema].DimService AS _DimService ON _DimService.ServiceKey = CAST(nc_product_item.site_id AS int) AND _DimService.Meta_IsCurrent = 1 LEFT JOIN productKey AS _productKey ON _productKey.seq_product_item_id = nc_product_item.seq_product_item_id LEFT JOIN /* Dimensional */ [schema].DimProduct AS _DimProduct ON _DimProduct.ProductKey = _productKey.ProductKey AND _DimProduct.Meta_IsCurrent = 1 INNER JOIN /* Dimensional */ [schema].DimMeterRegister AS _DimMeterRegister ON _DimMeterRegister.MeterRegisterKey = utl_meter_read.meter_id AND _DimMeterRegister.Meta_IsCurrent = 1 WHERE utl_meter_read.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_read_type.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR utl_read_sub_type.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID			
