# design test artefact			
# ARTEFACT: TRANSFORM_DimCustomer_Residential_tests			
# DESCRIPTION: Test each transformation rule			
SOURCE_SELECTION_CRITERIA	DESTINATION_SELECTION_CRITERIA	TEST	DESCRIPTION
REUSE_SQL	"FROM [schema].nc_client INNER JOIN [schema].crm_party ON nc_client.seq_party_id = crm_party.seq_party_id INNER JOIN [schema].crm_element_hierarchy ON crm_element_hierarchy.element_id = crm_party.seq_party_id INNER JOIN (SELECT nc_client.seq_party_id, MAX (CASE WHEN utl_account_status.accnt_status_class_id = 2 THEN 1 ELSE 0 END) AS CustomerStatus, MAX (CASE WHEN nc_client.Meta_LatestUpdate_TaskExecutionInstanceId > -2 OR nc_product.Meta_LatestUpdate_TaskExecutionInstanceId > -2 OR nc_product_item.Meta_LatestUpdate_TaskExecutionInstanceId > -2 THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema].nc_client LEFT OUTER JOIN [schema].nc_product ON nc_product.seq_party_id = nc_client.seq_party_id LEFT OUTER JOIN [schema].nc_product_item ON nc_product_item.seq_product_id = nc_product.seq_product_id LEFT OUTER JOIN [schema].utl_account_status ON utl_account_status.accnt_status_id = nc_product_item.accnt_status_id GROUP BY nc_client.seq_party_id) AS _customerStatus ON _customerStatus.seq_party_id = nc_client.seq_party_id LEFT OUTER JOIN (SELECT Complaint.ClientId, Complaint.IsOmbudsman, MAX(CASE WHEN Complaint.Meta_LatestUpdate_TaskExecutionInstanceId > -2 THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema].Complaint WHERE Complaint.IsOmbudsman = 1 AND Complaint.DateCreated >= DATEADD(YEAR, -1, GETDATE()) GROUP BY Complaint.ClientId, Complaint.IsOmbudsman) AS _ombudsmanComplaints ON _ombudsmanComplaints.ClientId = crm_party.party_code LEFT OUTER JOIN (SELECT nc_client.seq_party_id, MIN(ISNULL(nc_product.voice_ver_date,'9999-12-31')) AS EarliestVVDate, MAX (CASE WHEN nc_client.Meta_LatestUpdate_TaskExecutionInstanceId > -2 OR nc_product.Meta_LatestUpdate_TaskExecutionInstanceId > -2 THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema].nc_client LEFT OUTER JOIN [schema].nc_product ON nc_product.seq_party_id = nc_client.seq_party_id GROUP BY nc_client.seq_party_id) AS _joinDate ON _joinDate.seq_party_id = nc_client.seq_party_id WHERE crm_element_hierarchy.seq_element_type_id = '9'AND (crm_party.Meta_LatestUpdate_TaskExecutionInstanceId > -2 OR nc_client.Meta_LatestUpdate_TaskExecutionInstanceId > -2 OR crm_element_hierarchy.Meta_LatestUpdate_TaskExecutionInstanceId > -2 OR _customerStatus.Meta_HasChanged = 1 OR _ombudsmanComplaints.Meta_HasChanged = 1 OR _joinDate.Meta_HasChanged = 1)"		
[REUSE_SQL]		source.length.should.equal(destination.length)	row counts should match
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	parseInt(source[0].seq_party_id).should.equal(destination[0].CustomerKey)	1:1 map rule plus int cast
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	parseInt(source[0].party_code).should.equal(destination[0].CustomerCode)	1:1 map rule plus int cast
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].title.should.equal(destination[0].Title.trim())	1:1 map rule plus trim (Populated)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102881' 	WHERE `CustomerKey` = '2102881'	source[0].title.should.equal(destination[0].Title.trim())	1:1 map rule plus trim (Blank)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].first_name.should.equal(destination[0].Firstname)	1:1 map rule (Residential Customer)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].initials.should.equal(destination[0].MiddleInitial.trim())	1:1 map rule plus trim (Blank)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102881' 	WHERE `CustomerKey` = '2102881'	source[0].initials.should.equal(destination[0].MiddleInitial.trim())	1:1 map rule plus trim (Populated)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].last_name.should.equal(destination[0].LastName)	1:1 map rule (Residential Customer)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].party_name.should.equal(destination[0].PartyName)	1:1 map rule (Residential Customer)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].postal_addr_1.should.equal(destination[0].PostalAddressLine1)	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].postal_addr_2.should.equal(destination[0].PostalSuburb)	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].postal_post_code.should.equal(destination[0].PostalPostcode)	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101657'	WHERE `CustomerKey` = '2101657'	should.not.exist(destination[0].PostalState)	Should not exist from DQ filter
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].postal_addr_3.should.equal(destination[0].PostalState.trim())	1:1 map rule plus trim
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].postal_addr_3.should.equal(destination[0].PostalStateAsProvided.trim())	1:1 map rule plus trim
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].street_addr_1.should.equal(destination[0].ResidentialAddressLine1)	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].street_addr_2.should.equal(destination[0].ResidentialSuburb)	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101657'	WHERE `CustomerKey` = '2101657'	should.not.exist(destination[0].ResidentialState)	Should not exist from DQ filter
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].street_addr_3.should.equal(destination[0].ResidentialState.trim())	1:1 map rule plus trim
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].street_addr_3.should.equal(destination[0].ResidentialStateAsProvided.trim())	1:1 map rule plus trim
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	(source[0].std_code+source[0].phone_no).should.equal(destination[0].PrimaryPhone)	1:1 map rule plus concat
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	((source[0].primary_phone_type_id == '1') ? 'Landline' : (source[0].primary_phone_type_id == '2') ? 'Mobile' : '{Unknow}').should.equal(destination[0].PrimaryPhoneType.trim())	1:1 map rule plus trim (Landline)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101657'	WHERE `CustomerKey` = '2101657'	((source[0].primary_phone_type_id == '1') ? 'Landline' : (source[0].primary_phone_type_id == '2') ? 'Mobile' : '{Unknow}').should.equal(destination[0].PrimaryPhoneType.trim())	1:1 map rule plus trim (Mobile)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341387'	WHERE `CustomerKey` = '2341387'	should.not.exist(destination[0].PrimaryPhoneType)	1:1 map rule plus trim (Unknown)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101974'	WHERE `CustomerKey` = '2101974'	(source[0].secondary_std_code+source[0].secondary_phone_no).should.equal(destination[0].SecondaryPhone)	1:1 map rule plus concat
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341545'	WHERE `CustomerKey` = '2341545'	((source[0].secondary_phone_type_id == '1') ? 'Landline' : (source[0].secondary_phone_type_id == '2') ? 'Mobile' : '{Unknow}').should.equal(destination[0].SecondaryPhoneType.trim())	1:1 map rule plus trim (Landline)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101974'	WHERE `CustomerKey` = '2101974'	((source[0].secondary_phone_type_id == '1') ? 'Landline' : (source[0].secondary_phone_type_id == '2') ? 'Mobile' : '{Unknow}').should.equal(destination[0].SecondaryPhoneType.trim())	1:1 map rule plus trim (Mobile)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341387'	WHERE `CustomerKey` = '2341387'	should.not.exist(destination[0].SecondaryPhoneType)	1:1 map rule plus trim (Unknown)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101974'	WHERE `CustomerKey` = '2101974'	'0412123456'.should.equal(destination[0].MobilePhone.trim())	1:1 map rule plus trim
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101974'	WHERE `CustomerKey` = '2101974'	source[0].email_address.should.equal(destination[0].Email)	1:1 map rule (Known)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].email_address.should.equal(destination[0].Email)	1:1 map rule (Unknown)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].date_of_birth.toString().should.equal(destination[0].DateOfBirth.toString())	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	((source[0].seq_element_type_id == '9') ? 'Residential' : (source[0].seq_element_type_id == '8') ? 'Business' : 'NULL').should.equal(destination[0].CustomerType.trim())	1:1 map rule plus trim (Residential)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101974'	WHERE `CustomerKey` = '2101974'	'Active'.should.equal(destination[0].CustomerStatus.trim())	1:1 map rule plus trim (manually defined)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341387'	WHERE `CustomerKey` = '2341387'	'Inactive'.should.equal(destination[0].CustomerStatus.trim())	1:1 map rule plus trim (manually defined)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341545'	WHERE `CustomerKey` = '2341545'	'Yes'.should.equal(destination[0].OmbudsmanComplaints.trim())	1:1 map rule plus trim (manually defined)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101657'	WHERE `CustomerKey` = '2101657'	'No'.should.equal(destination[0].OmbudsmanComplaints.trim())	1:1 map rule plus trim (manually defined)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].insert_datetime.getFullYear().should.equal(destination[0].CreationDate.getFullYear())	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	source[0].insert_datetime.getMonth().should.equal(destination[0].CreationDate.getMonth())	1:1 map rule
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	'Sat Aug 20 2011 10:00:00 GMT+1000 (AUS Eastern Standard Time)'.should.equal(destination[0].JoinDate.toString())	1:1 map rule (manually defined)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341387'	WHERE `CustomerKey` = '2341387'	'Mon Jan 31 2005 11:00:00 GMT+1100 (AUS Eastern Daylight Time)'.should.equal(destination[0].JoinDate.toString())	1:1 map rule (manually defined)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2102891'	WHERE `CustomerKey` = '2102891'	((source[0].promo_allowed == 'E') ? 'Preferred contact by email' : (source[0].promo_allowed == 'P') ? 'Preferred contact by phone' : (source[0].promo_allowed == 'Y') ? 'Preferred contact by mail' :  (source[0].promo_allowed == 'N') ? 'Privacy: Do Not Contact' : 'NULL').should.equal(destination[0].PrivacyPreferredStatus)	1:1 map rule (phone)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341545'	WHERE `CustomerKey` = '2341545'	((source[0].promo_allowed == 'E') ? 'Preferred contact by email' : (source[0].promo_allowed == 'P') ? 'Preferred contact by phone' : (source[0].promo_allowed == 'Y') ? 'Preferred contact by mail' :  (source[0].promo_allowed == 'N') ? 'Privacy: Do Not Contact' : 'NULL').should.equal(destination[0].PrivacyPreferredStatus)	1:1 map rule (mail)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2101756'	WHERE `CustomerKey` = '2101756'	((source[0].promo_allowed == 'E') ? 'Preferred contact by email' : (source[0].promo_allowed == 'P') ? 'Preferred contact by phone' : (source[0].promo_allowed == 'Y') ? 'Preferred contact by mail' :  (source[0].promo_allowed == 'N') ? 'Privacy: Do Not Contact' : 'NULL').should.equal(destination[0].PrivacyPreferredStatus)	1:1 map rule (email)
[REUSE_SQL] AND `nc_client.seq_party_id` = '2341387'	WHERE `CustomerKey` = '2341387'	((source[0].promo_allowed == 'E') ? 'Preferred contact by email' : (source[0].promo_allowed == 'P') ? 'Preferred contact by phone' : (source[0].promo_allowed == 'Y') ? 'Preferred contact by mail' :  (source[0].promo_allowed == 'N') ? 'Privacy: Do Not Contact' : 'NULL').should.equal(destination[0].PrivacyPreferredStatus)	1:1 map rule (do not contact)
