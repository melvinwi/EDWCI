# design artefact				
# ARTEFACT: TRANSFORM_DimOrganisation				
# DESCRIPTION: Construct Sales Organisation Structure from Orion tables to DataStore 				
SOURCE_FUNCTION_PREFIX	SOURCE	SOURCE_FUNCTION_SUFFIX	DESTINATION	DESCRIPTION
WITH_STATEMENTS	"WITH _Level4 AS  (  SELECT Party.seq_party_id OrgId, Party.party_code OrgCode, Party.party_name OrgName, hrc.element_struct_code StructureName, hrc.parent_id ParentId, hrc.parent_element_struct_code ParentStructureName  , MAX(CASE WHEN party.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR hrc.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged   FROM [schema].Crm_party party    INNER JOIN [schema].Crm_element_hierarchy hrc ON hrc.element_id = seq_party_id   WHERE element_struct_code = 'GROUP'  GROUP BY Party.seq_party_id, Party.party_code, Party.party_name, hrc.element_struct_code, hrc.parent_id, hrc.parent_element_struct_code ) , _Level3 AS  (  SELECT Party.seq_party_id OrgId, Party.party_code OrgCode, Party.party_name OrgName, hrc.element_struct_code StructureName, hrc.parent_id ParentId, hrc.parent_element_struct_code ParentStructureName  , MAX(CASE WHEN party.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR hrc.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged   FROM [schema].Crm_party party    INNER JOIN [schema].Crm_element_hierarchy hrc ON hrc.element_id = seq_party_id   WHERE element_struct_code = 'COMPANY'  GROUP BY Party.seq_party_id, Party.party_code, Party.party_name, hrc.element_struct_code, hrc.parent_id, hrc.parent_element_struct_code ) , _Level2 AS  (  SELECT Party.seq_party_id OrgId, Party.party_code OrgCode, Party.party_name OrgName, hrc.element_struct_code StructureName, hrc.parent_id ParentId, hrc.parent_element_struct_code ParentStructureName  , MAX(CASE WHEN party.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR hrc.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged   FROM [schema].Crm_party party    INNER JOIN [schema].Crm_element_hierarchy hrc ON hrc.element_id = seq_party_id   WHERE element_struct_code = 'SALESGRP' OR element_struct_code = 'DEPARTMENT'  GROUP BY Party.seq_party_id, Party.party_code, Party.party_name, hrc.element_struct_code, hrc.parent_id, hrc.parent_element_struct_code ) , _Level1 AS  (  SELECT Party.seq_party_id OrgId, Party.party_code OrgCode, Party.party_name OrgName, hrc.element_struct_code StructureName, hrc.parent_id ParentId, hrc.parent_element_struct_code ParentStructureName  , MAX(CASE WHEN party.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR hrc.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged   FROM [schema].Crm_party party    INNER JOIN [schema].Crm_element_hierarchy hrc ON hrc.element_id = seq_party_id   WHERE element_struct_code = 'SALESDEPT'  GROUP BY Party.seq_party_id, Party.party_code, Party.party_name, hrc.element_struct_code, hrc.parent_id, hrc.parent_element_struct_code  )"			Account status temporary table provides a binary value for open pending error or closed
CAST(	_Level1.OrgCode	AS nchar(10))	DimOrganisation.OrganisationCode	One to one mapping with int cast and isnumeric to prevent execution plan issues
CAST(	_Level1.OrgId	AS int)	DimOrganisation.OrganisationKey	One to one mapping with int cast
CAST(ISNULL(	"_Level1.OrgName, ISNULL(_Level2.OrgName, _Level3.OrgName)"	) AS nvarchar(100))	DimOrganisation.OrganisationName	
CAST(	_Level1.OrgName	AS nvarchar(100))	DimOrganisation.Level1Name	One to one mapping with nvarchar cast
CAST(	_Level2.OrgName	AS nvarchar(100))	DimOrganisation.Level2Name	One to one mapping with nvarchar cast
CAST(	_Level3.OrgName	AS nvarchar(100))	DimOrganisation.Level3Name	One to one mapping with nvarchar cast
CAST(	_Level4.OrgName	AS nvarchar(100))	DimOrganisation.Level4Name	One to one mapping with nvarchar cast
SELECTION_CRITERIA	FROM _Level4  LEFT JOIN _Level3 ON _Level3.ParentId = _Level4.OrgId  LEFT JOIN _Level2 ON _Level2.ParentId = _Level3.OrgId  LEFT JOIN _Level1 ON _Level1.ParentId = _Level2.OrgId WHERE (_Level1.Meta_HasChanged = 1 OR _Level2.Meta_HasChanged = 1 OR _Level3.Meta_HasChanged = 1 OR _Level4.Meta_HasChanged = 1)			
