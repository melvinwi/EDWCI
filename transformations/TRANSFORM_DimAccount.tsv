# design artefact				
# ARTEFACT: TRANSFORM_DimAccount				
# DESCRIPTION: Promote accounts from Orion tables to DataStore 				
SOURCE_FUNCTION_PREFIX	SOURCE	SOURCE_FUNCTION_SUFFIX	DESTINATION	DESCRIPTION
WITH_STATEMENTS	"WITH accountStatus AS (SELECT nc_client.seq_party_id, MIN(nc_product_item.accnt_status_date) AS MinAccountStatusDate, MAX (nc_product_item.accnt_status_date) AS MaxAccountStatusDate, MAX (CASE WHEN utl_account_status.accnt_status_class_id = '2' THEN 1 ELSE 0 END) AS StatusOpen, MAX (CASE WHEN utl_account_status.accnt_status_class_id = '3' THEN 1 ELSE 0 END) AS StatusPending, MAX (CASE WHEN utl_account_status.accnt_status_class_id = '4' THEN 1 ELSE 0 END) AS StatusError, MAX (CASE WHEN nc_client.Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID OR nc_product.Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID OR nc_product_item.Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema].nc_client LEFT OUTER JOIN [schema].nc_product ON nc_product.seq_party_id = nc_client.seq_party_id LEFT OUTER JOIN [schema].nc_product_item ON nc_product_item.seq_product_id = nc_product.seq_product_id LEFT OUTER JOIN [schema].utl_account_status ON utl_account_status.accnt_status_id = nc_product_item.accnt_status_id GROUP BY nc_client.seq_party_id)"			Account status temporary table provides a binary value for open pending error or closed
CAST(	nc_client.seq_party_id	AS int)	DimAccount.AccountKey	One to one mapping with int cast
CASE WHEN ISNUMERIC (crm_party.party_code) = 1 THEN CAST(	crm_party.party_code	AS int) END	DimAccount.AccountCode	One to one mapping with int cast and isnumeric to prevent execution plan issues
CAST(	crm_party.postal_addr_1	AS nvarchar(100))	DimAccount.PostalAddressLine1	One to one mapping with nvarchar cast
CAST(	crm_party.postal_addr_2	AS nvarchar(50))	DimAccount.PostalSuburb	One to one mapping with nvarchar cast
CAST(	crm_party.postal_post_code	AS nchar(4))	DimAccount.PostalPostcode	One to one mapping with nchar cast
CASE WHEN LEFT(UPPER(	crm_party.postal_addr_3	"),3) IN ('ACT','NSW','NT','QLD','SA','TAS','VIC','WA') THEN LEFT(UPPER(crm_party.postal_addr_3),3) ELSE NULL END"	DimAccount.PostalState	One to one mapping with data quality fix
CAST(	crm_party.postal_addr_3	AS nchar(3))	DimAccount.PostalStateAsProvided	One to one mapping with nchar cast often truncates
CAST (CASE WHEN 	_accountStatus.StatusOpen	= 1 THEN 'Open' WHEN _accountStatus.StatusPending = 1 THEN 'Pending' WHEN _accountStatus.StatusError = 1 THEN 'Error' ELSE 'Closed' END AS nchar (10))	DimAccount.AccountStatus	Use WITH table to populate Account Status
	nc_client.insert_datetime		DimAccount.AccountCreationDate	One to one mapping
CAST(CASE WHEN (	_accountStatus.StatusOpen	 = 1 OR  _accountStatus.StatusPending = 1  OR _accountStatus.StatusError = 1 ) THEN NULL ELSE _accountStatus.MaxAccountStatusDate END AS date)	DimAccount.AccountClosedDate	Use WITH table to populate Account Closed Date
CAST(	nc_credit_control_status.seq_credit_status_desc	AS nvarchar(50))	DimAccount.CreditControlStatus	One to one mapping with nvarchar cast
	_creditControlCategory.CreditControlCategory		DimAccount.CreditControlCategory	
CAST(	nc_inv_deliver_mode.inv_del_mode_desc	AS nvarchar(50))	DimAccount.InvoiceDeliveryMethod	One to one mapping with nvarchar cast
CAST (CASE	nc_client.seq_pay_method_id	 WHEN 14 THEN 'Cheque' WHEN 17 THEN 'Direct Credit' WHEN 18 THEN 'Direct Debit' WHEN 22 THEN 'Credit Card' ELSE NULL END AS NVARCHAR(20))	DimAccount.PaymentMethod	One to one mapping with nvarchar cast
CAST(CASE	nc_client.cz_registered	WHEN 'Y' THEN 'Registered' ELSE 'Not Registered' END AS nvarchar(14))	DimAccount.MyAccountStatus	Decode My Account Status
CAST(NULLIF(	nc_client.user_defined_1	",'') AS nvarchar(100))"	DimAccount.ACN	One to one mapping with nvarchar cast
CAST(NULLIF(	nc_client.user_defined_2	",'') AS nvarchar(100))"	DimAccount.ABN	One to one mapping with nvarchar cast
SELECTION_CRITERIA	FROM [schema].nc_client INNER JOIN [schema].crm_party ON nc_client.seq_party_id = crm_party.seq_party_id INNER JOIN accountStatus AS _accountStatus ON _accountStatus.seq_party_id = nc_client.seq_party_id LEFT JOIN [schema].nc_credit_control_status ON nc_credit_control_status.seq_credit_status_id = nc_client.seq_credit_status_id LEFT JOIN [schema].CreditControlCategory AS _CreditControlCategory ON _CreditControlCategory.seq_credit_status_id = nc_client.seq_credit_status_id  LEFT JOIN [schema].nc_inv_deliver_mode ON nc_inv_deliver_mode.seq_inv_del_mode_id = nc_client.seq_inv_del_mode_id WHERE (crm_party.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR nc_client.Meta_LatestUpdate_TaskExecutionInstanceId > @LatestSuccessfulTaskExecutionInstanceID OR _accountStatus.Meta_HasChanged = 1)			
