
h2. ARTEFACT: TRANSFORM_DimAccount

DESCRIPTION: Promote accounts from Orion tables to DataStore

|*SOURCE_FUNCTION_PREFIX*	|*SOURCE*	|*SOURCE_FUNCTION_SUFFIX*	|*DESTINATION*	|*DESCRIPTION*	|
|WITH_STATEMENTS	|"WITH accountStatus AS (SELECT "nc_client":../staging/nc_client.textile .seq_party_id, MAX (CASE WHEN utl_account_status.accnt_status_class_id = '2' THEN 1 ELSE 0 END) AS StatusOpen, MAX (CASE WHEN utl_account_status.accnt_status_class_id = '3' THEN 1 ELSE 0 END) AS StatusPending, MAX (CASE WHEN utl_account_status.accnt_status_class_id = '4' THEN 1 ELSE 0 END) AS StatusError, MAX (CASE WHEN "nc_client":../staging/nc_client.textile .Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID OR nc_product.Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID OR nc_product_item.Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID THEN 1 ELSE 0 END) AS Meta_HasChanged FROM [schema]."nc_client":../staging/nc_client.textile  LEFT OUTER JOIN [schema].nc_product ON nc_product.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id LEFT OUTER JOIN [schema].nc_product_item ON nc_product_item.seq_product_id = nc_product.seq_product_id LEFT OUTER JOIN [schema].utl_account_status ON utl_account_status.accnt_status_id = nc_product_item.accnt_status_id GROUP BY "nc_client":../staging/nc_client.textile .seq_party_id)"	|	|	|Account status temporary table provides a binary value for open pending error or closed	|
|CASE WHEN ISNUMERIC ("crm_party":../staging/crm_party.textile .party_code) = 1 THEN CAST(	|"crm_party":../staging/crm_party.textile .party_code	|AS int) END	|"DimAccount":../datastore/DimAccount.textile .AccountCode	|One to one mapping with int cast and isnumeric to prevent execution plan issues	|
|CAST(	|"nc_client":../staging/nc_client.textile .seq_party_id	|AS int)	|"DimAccount":../datastore/DimAccount.textile .AccountKey	|One to one mapping with int cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_1	|AS nvarchar(100))	|"DimAccount":../datastore/DimAccount.textile .PostalAddressLine1	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_2	|AS nvarchar(50))	|"DimAccount":../datastore/DimAccount.textile .PostalSuburb	|One to one mapping with nvarchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_post_code	|AS nchar(4))	|"DimAccount":../datastore/DimAccount.textile .PostalPostcode	|One to one mapping with nchar cast	|
|CAST(	|"crm_party":../staging/crm_party.textile .postal_addr_3	|AS nchar(3))	|"DimAccount":../datastore/DimAccount.textile .PostalState	|One to one mapping with nchar cast	|
|CAST(CASE	|"nc_client":../staging/nc_client.textile .cz_registered	|WHEN 'Y' THEN 'Registered' ELSE 'Not Registered' END AS nvarchar(14))	|"DimAccount":../datastore/DimAccount.textile .MyAccountStatus	|Decode My Account Status	|
|	|"nc_client":../staging/nc_client.textile .insert_datetime	|	|"DimAccount":../datastore/DimAccount.textile .CreationDate	|One to one mapping	|
|CAST (CASE WHEN 	|_accountStatus.StatusOpen	|= 1 THEN 'Open' WHEN _accountStatus.StatusPending = 1 THEN 'Pending' WHEN _accountStatus.StatusError = 1 THEN 'Error' ELSE 'Closed' END AS nchar (10))	|"DimAccount":../datastore/DimAccount.textile .AccountStatus	|Use WITH table to populate Account Status	|
|CAST (CASE	|"nc_client":../staging/nc_client.textile .seq_pay_method_id	| WHEN 14 THEN 'Cheque' WHEN 17 THEN 'Direct Credit' WHEN 18 THEN 'Direct Debit' WHEN 22 THEN 'Credit Card' ELSE NULL END AS NVARCHAR(20))	|"DimAccount":../datastore/DimAccount.textile .PaymentMethod	|One to one mapping with nvarchar cast	|
|SELECTION_CRITERIA	|FROM [schema]."nc_client":../staging/nc_client.textile  INNER JOIN [schema]."crm_party":../staging/crm_party.textile  ON "nc_client":../staging/nc_client.textile .seq_party_id = "crm_party":../staging/crm_party.textile .seq_party_id INNER JOIN accountStatus AS _accountStatus ON _accountStatus.seq_party_id = "nc_client":../staging/nc_client.textile .seq_party_id WHERE ("crm_party":../staging/crm_party.textile .Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID OR "nc_client":../staging/nc_client.textile .Meta_LatestUpdate_TaskExecutionInstanceId >= @LatestSuccessfulTaskExecutionInstanceID OR _accountStatus.Meta_HasChanged = 1)|

